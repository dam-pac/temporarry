1) Установка Samba на BR-SRV:
 
dnf install samba* krb5* docker-ce docker-compose -y
sudo mv /etc/samba/smb.conf /etc/samba/smb.conf.bak
sudo mv /etc/krb5.conf /etc/krb5.conf.bak
nano /etc/krb5.conf.d/crypto-policies
default_tgs_enctypes
default_tkt_enctypes
permitted_enctypes
samba-tool domain provision --use-rfc2307 --interactive
cp /var/lib/samba/private/krb5.conf /etc/krb5.conf
nano /etc/krb5.conf ### в realms добавляем kdc
systemctl enable --now samba
samba-tool group add hq
for i in {1..5}; do samba-tool user add hquser$i P@ssw0rd; samba-tool group addmembers hq hquser$i; done

Переходим на HQ-CLI, переходим в root (sudo -i) и пишем:
echo “172.30.100.10 au-team.irpo” >> /etc/hosts
realm join -U -v Administrator@AU-TEAM.IRPO

Переходим на HQ-CLI
nano /etc/sssd/sssd.conf
systemctl restart sssd 
nano /etc/krb5.conf

Далее переходим в «Настройки» - «Сетевые учетные записи».
Выбираем Kerberos, вводим Administrator@AU-TEAM.IRPO и P@ssw0rd.
sss_cache -E
visudo
%hq@au-team.irpo ALL=(ALL) /bin/cat, /bin/grep, /bin/id

2) Конфигурация файлового хранилища на HQ-SRV:
fdisk /dev/sdX
g
n
W
- mdadm --create /dev/md0 -l 0 -n 2 /dev/sd[b-c]

mkfs.ext4 /dev/md0
mkdir /raid
nano /etc/fstab
- /dev/md0	/raid	ext4	defaults	0 0

- systemctl daemon-reload 
- mount -a

3) Настройка сервера сетевой файловой системы (nfs) на HQ-SRV:
- dnf install nfs4-acl-tools mariadb-server httpd php php-mysqlnd php-cli -y
- mkdir /raid/nfs
- chown nobody:nobody /raid/nfs
- chmod 7777 /raid/nfs
- nano /etc/exports

Добавляем в него следующую строчку:
- /raid/nfs	192.168.200.0/28 (rw)

- exportfs -a
- systemctl enable --now nfs-server

Переходим на HQ-CLI:
- mkdir /mnt/nfs
- nano /etc/fstab
Добавляем следующую строчку:
192.168.100.10:/raid/nfs /mnt/nfs nfs auto 0 0

- mount -a
- systemctl daemon-reload
- df -h

4) Служба сетевого времени (chrony)
На ISP:
- nano /etc/chrony.conf

комментируем первые 3 сервера (ntp1-3):
local stratum 5
allow 0/0
hwtimestamp *

- systemctl restart chronyd
- chronyc sources

На HQ-SRV,HQ-CLI,BR-RTR,BR-SRV:
- nano /etc/chrony.conf
server 172.16.4.1 iburst prefer

Далее перезапускаем сервис:
- systemctl restart chronyd
- chronyc sources

5) Установка ansible на сервере BR-SRV
- nano /etc/ansible/demo.ini

[all]
hq-srv ansible_host=192.168.100.10 ansible_user=sshuser ansible_port=2026
hq-cli ansible_host=192.168.200.2 ansible_user=username
hq-rtr ansible_host=192.168.100.1 ansible_user=net_admin
br-rtr ansible_host=172.30.100.1 ansible_user=net_admin

- ssh-keygen -t rsa (пароль от sshuser, username - P@ssw0rd, net_admin - P@$$w0rd)
- ssh-copy-id -p 2026 sshuser@192.168.100.10
- ssh-copy-id username@192.168.200.2
- ssh-copy-id net_admin@192.168.100.1
- ssh-copy-id net_admin@172.30.100.1

- nano /etc/ansible/ansible.cfg

[defaults]
Inventory = /etc/ansible/demo.ini
ask_pass = False
host_key_checking = False
interpreter_python=/usr/bin/python

Проверяем настройку:
- ansible -m ping all

6) Развертывание приложений в Docker на сервере BR-SRV:
- mount /dev/cdrom /mnt
- systemctl enable --now docker
- docker load < /mnt/docker/site_latest.tar
- docker load < /mnt/docker/mariadb_latest.tar
- nano site.yml
services:
  db:
    image: mariadb:10.11
    container_name: db
    environment:
      MARIADB_DATABASE: testdb
      MARIADB_USER: test
      MARIADB_PASSWORD: Passw0rd
      MARIADB_ROOT_PASSWORD: Passw0rd
    volumes:
      - db_data:/var/lib/mysql
    restart: unless-stopped
  testapp:
    image: site
    container_name: testapp
    environment:
      DB_TYPE: maria
      DB_HOST: db
      DB_NAME: testdb
      DB_USER: test
      DB_PASS: Passw0rd
      DB_PORT: 3306
    ports:
      - "8080:8000"
    depends_on:
      - db
    restart: unless-stopped
volumes:
  db_data:

- docker-compose -f site.yml up -d

7) Развертывание веб приложения на сервере HQ-SRV:
- mount /dev/cdrom /mnt
- systemctl enable --now mariadb httpd
- mysql_secure_installation
- P@ssw0rd (n,n,y,y,y,y)
- mysql -u root -pP@ssw0rd
- CREATE USER 'web'@'localhost' IDENTIFIED BY 'P@ssw0rd';
- CREATE DATABASE webdb DEFAULT CHARACTER SET utf8;
- GRANT ALL PRIVILEGES ON webdb.* TO 'web'@'localhost';
- flush privileges;
- quit
- mysql -u root -pP@ssw0rd webdb < /mnt/web/dump.sql
- cp /mnt/web/index.php /var/www/html
- cp /mnt/web/logo.png /var/www/html
- nano /var/www/html/index.php

$servername = 'localhost'
$username = 'web'
$password = 'P@ssw0rd'
$dbname = 'webdb'

- systemctl restart httpd

HQ-SRV:
- nano /opt/dns/au-team.irpo
web    A       172.16.4.1
docker A       172.16.5.1  
- systemctl restart named

8) Статическая трансляция портов:
BR-RTR:
firewall-cmd --zone=trusted --add-rich-rule='rule family="ipv4" destination address="172.16.5.2" forward-port port="2024" protocol="tcp" to-port="2024" to-addr="172.30.100.10"' --permanent
firewall-cmd --zone=trusted --add-rich-rule='rule family="ipv4" destination address="172.16.5.2" forward-port port="8080" protocol="tcp" to-port="8080" to-addr="172.30.100.10"' --permanent
firewall-cmd --reload
systemctl restart firewalld
HQ-RTR:
firewall-cmd --zone=trusted --add-rich-rule='rule family="ipv4" destination address="172.16.4.2" forward-port port="2024" protocol="tcp" to-port="2024" to-addr="192.168.100.10"' --permanent
firewall-cmd --zone=trusted --add-rich-rule='rule family="ipv4" destination address="172.16.4.2" forward-port port="8080" protocol="tcp" to-port="80" to-addr="192.168.100.10"' --permanent
firewall-cmd --reload
systemctl restart firewalld

9) Настройка веб-сервера nginx как обратный прокси-сервер на ISP:
- dnf install nginx httpd-tools -y
- systemctl enable --now nginx
- htpasswd -c /etc/nginx/.htpasswd WEB (P@ssw0rd)
- nano /etc/nginx/nginx.conf 

server {
	listen 80;
	server_name docker.au-team.irpo;
 	location / {
		proxy_pass http://172.16.5.2:8080;
	}
}
server {
	listen 80;
	server_name web.au-team.irpo;
 	location / {
		proxy pass http://172.16.4.2:8080;
		auth_basic “Restricted Content”;
		auth_basic_user_file /etc/nginx/.htpasswd;
	}
}

- systemctl restart nginx
- nano /etc/selinux/config
Меняем параметр SELINUX на disabled









